name: å¾®ä¿¡æ—¥å¿—æ¨é€

on:
  # ä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  send-wechat:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@v3
    
    # 2. è®¾ç½® Python ç¯å¢ƒ
    - name: è®¾ç½® Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    # 3. å®‰è£…ä¾èµ–
    - name: å®‰è£… Python ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests numpy pandas scipy
    
    # 4. è¿è¡Œ select_stock.py ç”Ÿæˆæ—¥å¿—
    - name: è¿è¡Œè‚¡ç¥¨ç­›é€‰ç¨‹åº
      run: |
        echo "ğŸ“Š å¼€å§‹è¿è¡Œ select_stock.py..."
        python select_stock.py --data-dir ./data --config ./configs.json
        echo "âœ… select_stock.py è¿è¡Œå®Œæˆ"
    
    # 5. æ£€æŸ¥ç”Ÿæˆçš„æ—¥å¿—æ–‡ä»¶
    - name: æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
      run: |
        if [ -f "select_results.log" ]; then
          echo "âœ… æ—¥å¿—æ–‡ä»¶å·²ç”Ÿæˆ"
          echo "ğŸ“„ æ—¥å¿—æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -n 20 select_results.log
        else
          echo "âŒ æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
    
    # 6. è¿è¡Œå¾®ä¿¡æ¨é€è„šæœ¬
    - name: è¿è¡Œå¾®ä¿¡æ¨é€
      env:
        SENDKEY: ${{ secrets.WECHAT_SENDKEY }}  # ä» GitHub Secrets è¯»å–
      run: |
        python wechatsend.py
    
    # 7. ä¸Šä¼ è¿è¡Œæ—¥å¿— (å¯é€‰ï¼Œç”¨äºè°ƒè¯•)
    - name: ä¸Šä¼ è¿è¡Œæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: workflow-logs
        path: |
          select_results.log
        retention-days: 7
