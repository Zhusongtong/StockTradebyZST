name: 微信日志推送

on:
  # 仅支持手动触发
  workflow_dispatch:

jobs:
  send-wechat:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 检出代码
    - name: 检出仓库代码
      uses: actions/checkout@v3
    
    # 2. 设置 Python 环境
    - name: 设置 Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    # 3. 安装依赖
    - name: 安装 Python 依赖
      run: |
        python -m pip install --upgrade pip
        pip install requests numpy pandas scipy
    
    # 4. 运行 select_stock.py 生成日志
    - name: 运行股票筛选程序
      run: |
        echo "📊 开始运行 select_stock.py..."
        python select_stock.py --data-dir ./data --config ./configs.json
        echo "✅ select_stock.py 运行完成"
    
    # 5. 检查生成的日志文件
    - name: 检查日志文件
      run: |
        if [ -f "select_results.log" ]; then
          echo "✅ 日志文件已生成"
          echo "📄 日志文件内容预览:"
          head -n 20 select_results.log
        else
          echo "❌ 日志文件不存在"
          exit 1
        fi
    
    # 6. 运行微信推送脚本
    - name: 运行微信推送
      env:
        SENDKEY: ${{ secrets.WECHAT_SENDKEY }}  # 从 GitHub Secrets 读取
      run: |
        python wechatsend.py
    
    # 7. 上传运行日志 (可选，用于调试)
    - name: 上传运行日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: workflow-logs
        path: |
          select_results.log
        retention-days: 7
